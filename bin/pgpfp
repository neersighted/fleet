#!/usr/bin/env bash

GPGARGS="--no-secmem-warning"

email=$1
key=$2
uri=$3

fingerprint=$(gpg ${GPGARGS} --list-keys --fingerprint "${key}" | grep "Key fingerprint" | tr -d ' ' | cut -c 16-60)
fingerprintlen=$(dc -e "16 o ${#fingerprint} 2 / p")
fingerprintbin=$(print "${fingerprintlen}${fingerprint}" | tr 'A-F' 'a-f' | xxd -p -r)

pka="v=pka1;fpr=${fingerprint};uri=${uri}"
ipgp=$(print "${fingerprintbin}${uri}" | base64 --wrap=0)
pgp=$(gpg ${GPGARGS} --export --export-options export-minimal "${key}" | base64 --wrap=76 | sed 's/^/    /g')

echo "${email/@/._pka.}. TXT \"${pka}\""
echo "${email/@/.}. CERT IPGP 0 0 ${ipgp}"
echo "${email/@/.}. CERT PGP 0 0 ("
echo "${pgp}"
echo ")"
