#!/usr/bin/env bash

source bin/colors


targets=$@

if [ -z "${targets}" ]; then
  echo -e "${bold}${red}====> Domain(s) not specified${reset}"
  exit 1
fi

for target in ${targets}; do
  offline=
  unsynced=

  echo -e "${bold}${blue}====> Check serials [${green}${target}${blue}]${reset}"

  echo -e "${bold}${blue}----> Get master namserver${reset}"
  master_server=$(dig ${target} soa | grep SOA | grep -v "^;" | awk '{print $5}')

  echo -e "${green}${master_server}${blue} is master for ${green}${target}${blue}${reset}"
  master_serial=$(dig @${master_server} ${target} soa | grep SOA | grep -v "^;" | awk '{print $7}')

  echo -e "${bold}${blue}----> Check nameserver serials${reset}"
  for server in $(dig @${master_server} ${target} ns | grep NS | grep -v "^;" | awk '{ORS=" "}{print $5}'); do
    echo -en "${blue}${server} : ${reset}"

    serial=$(dig @${server} ${target} soa | grep SOA | grep -v "^;" | awk '{print $7}')

    if [ -n "${serial}" ]; then
      echo -en "${green}${serial}${reset}"
      if [ $master_serial == $serial ]; then
        echo -e " ${bold}${green}:)${reset}"
      else
        echo -e " ${bold}${red}:(${reset}"
        unsynced=1
      fi
    else
      echo -e "${green}no results ${bold}${red}D:${reset}"
      offline=1
    fi
  done

  if [ -n "${offline}" ]; then
    echo -e "${bold}${red}====> Some servers are not responding${reset}"
  elif [ -n "${unsynced}" ]; then
    echo -e "${bold}${red}====> Some servers are out of sync${reset}"
  else
    echo -e "${bold}${green}====> All servers are in sync${reset}"
  fi
  echo -e "${bold}${normal}---------------${reset}"
done
