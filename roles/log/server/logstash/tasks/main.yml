- name: transfer logstash keys
  tags: [logstash, server, log]
  with_items: ['{{ key }}', '{{ cert }}']
  copy: src={{ item }} dest=/etc/logstash/{{ item|basename }}

- name: configure logstash grok patterns
  tags: [logstash, server, log]
  copy: src=patterns/ dest=/opt/logstash/patterns/
  notify: restart logstash

- name: configure logstash
  tags: [logstash, server, log]
  copy: src=conf.d/ dest=/etc/logstash/conf.d/
  notify: restart logstash

- name: validate logstash config
  tags: [logstash, server, log]
  command: /opt/logstash/bin/logstash agent --config /etc/logstash/conf.d/ --configtest
  changed_when: false

- name: enable and start logstash
  tags: [logstash, server, log]
  service: name=logstash state=started enabled=yes
