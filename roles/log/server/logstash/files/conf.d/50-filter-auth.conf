filter {
  if [type] == "auth" {
    # Strip out the message.
    grok {
      match => [ "message", "%{SYSLOGTIMESTAMP:timestamp} %{SYSLOGHOST:auth_host} %{DATA:auth_source}(\[%{POSINT}\])?: %{GREEDYDATA:message}" ]
      overwrite => [ "message" ]
    }

    grok {
      match => [ "message", "Accepted %{DATA:auth_method} for %{USERNAME:auth_user} from %{IPORHOST:auth_ip} port %{POSINT:auth_port} ssh2(: %{GREEDYDATA:auth_key})?" ]
      add_field => { "auth_event" => "ssh" }
    }
    grok {
      match => [
        "message", "Connection closed by %{IP:auth_ip}",
        "message", "Received disconnect from %{IP:auth_ip}"
      ]
      add_field => { "auth_event" => "ssh_disconnect" }
    }
    grok {
      match => [
        "message", "Disconnecting: Too many authentication failures for %{USER:auth_user}",
        "message", "Disconnecting: Change of username or service not allowed: \(%{USERNAME:auth_user},ssh-connection\) -> \(%{USERNAME:auth_newuser},ssh-connection\)",
        "message", "Failed %{DATA:auth_type} for %{USERNAME:auth_user} from %{IPORHOST:auth_ip} port %{POSINT:auth_port}( ssh2(: %{GREEDYDATA:auth_key})?)?"
      ]
      add_field => { "auth_event" => "ssh_fail" }
    }
    grok {
      match => [ "message", "Invalid user %{USERNAME:auth_user} from %{IP:auth_ip}" ]
      add_field => { "auth_event" => "ssh_invalid" }
    }

    grok {
      match => [
        "message", "%{USERNAME:auth_user} : TTY=%{DATA:atth_tty} ; PWD=%{UNIXPATH} ; USER=%{USERNAME:auth_newuser} ; TSID=%{DATA:auth_tsid} ; COMMAND=%{GREEDYDATA:auth_command}",
        "message", "%{USERNAME:auth_user} : TTY=%{DATA:auth_tty} ; PWD=%{UNIXPATH} ; USER=%{USERNAME:auth_newuser} ; COMMAND=%{GREEDYDATA:auth_command}"
      ]
      add_field => { "auth_event" => "sudo" }
    }
    grok {
      match => [ "message", "%{USERNAME:auth_user} : \(command continued\) %{GREEDYDATA:auth_command}" ]
      add_field => { "auth_event" => "sudo_cont" }
    }
    grok {
      match => [ "message", "%{USERNAME:auth_user} : %{POSINT} incorrect password attempts ; TTY=%{DATA:auth_tty} ; PWD=%{UNIXPATH} ; USER=%{USERNAME:auth_newuser} ; COMMAND=%{GREEDYDATA:auth_command}" ]
      add_field => { "auth_event" => "sudo_fail" }
    }

    grok {
      match => [ "message", "Successful su for %{USERNAME:auth_newuser} by %{USERNAME:auth_user}" ]
      add_field => { "auth_event" => "su" }
    }
    grok {
      match => [ "message", "FAILED su for %{USERNAME:auth_newuser} by %{USERNAME:auth_user}" ]
      add_field => { "auth_event" => "su_fail" }
    }

    # Redundant!
    if [message] =~ /^input_userauth_request: invalid user/ {
      drop { }
    }
    # Useless!
    if [message] =~ /reverse mapping checking getaddrinfo/ {
      drop { }
    }
    # Useless!
    if [message] =~ /^Did not receive identification string/ {
      drop { }
    }

    # Useless!
    if [message] =~ /^(\+|\-) \/dev/ {
      drop { }
    }

    # Redundant!
    if [message] =~ /^pam_unix/ {
      drop { }
    }
    # Redundant!!
    if [message] =~ /^pam_authenticate/ {
      drop { }
    }


    # If there is no event type, set the default.
    if ![auth_event] {
      mutate {
        add_field => { "auth_event" => "other" }
      }
    }


    geoip {
      source => "auth_ip"
    }

    date {
      match => [ "timestamp", "MMM  d HH:mm:ss", "MMM dd HH:mm:ss" ]
      remove_field => [ "timestamp" ]
    }
  }
}
